<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Command Center - Nanda Teknik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; overflow: hidden; }
        .mobile-container { max-width: 480px; height: 100vh; margin: 0 auto; background: #fff; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        #map { flex: 1; width: 100%; z-index: 1; }
        
        /* Glassmorphism Effect */
        .stat-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 0.8); }
        
        .pulse-red {
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 10px 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body>

    <div class="mobile-container">
        <div class="p-5 pb-2 bg-white border-b">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-xs font-black text-slate-400 uppercase tracking-widest">Command Center</h1>
                    <div class="text-xl font-black text-slate-800 italic">NANDA<span class="text-blue-600">TEKNIK</span></div>
                </div>
                <div class="flex gap-2">
                    <button class="w-10 h-10 bg-slate-900 text-white rounded-full flex items-center justify-center shadow-lg active:scale-90 transition">
                        âž•
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-3 mb-2">
                <div class="stat-card p-3 rounded-2xl text-center">
                    <div id="countAntrian" class="text-lg font-black text-orange-500">0</div>
                    <div class="text-[9px] font-bold text-slate-400 uppercase">Antrian</div>
                </div>
                <div class="stat-card p-3 rounded-2xl text-center">
                    <div id="countProses" class="text-lg font-black text-blue-500">0</div>
                    <div class="text-[9px] font-bold text-slate-400 uppercase">Proses</div>
                </div>
                <div class="stat-card p-3 rounded-2xl text-center border-emerald-100">
                    <div id="countSelesai" class="text-lg font-black text-emerald-500">0</div>
                    <div class="text-[9px] font-bold text-slate-400 uppercase">Selesai</div>
                </div>
            </div>
        </div>

        <div id="map"></div>

        <div class="absolute bottom-6 left-1/2 -translate-x-1/2 z-[2000] flex gap-3 w-full px-10">
            <a href="pelanggan.html" class="flex-1 bg-white border border-slate-200 py-3 rounded-2xl shadow-xl flex items-center justify-center gap-2 font-black text-xs text-slate-700 active:scale-95 transition">
                ðŸ‘¥ DATABASE
            </a>
            <button onclick="location.reload()" class="w-12 h-12 bg-white border border-slate-200 rounded-2xl shadow-xl flex items-center justify-center active:rotate-180 transition-all duration-500">
                ðŸ”„
            </button>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzCJTj3wdfl-a2x8BO0bha9-X05KiJAcv7EBp0G0vXBRyPvEfLlqznGoR1mkeFJPVgBVw/exec";
        let map, markerGroup;

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([-8.2191, 114.3691], 12);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
            markerGroup = L.layerGroup().addTo(map);
        }

        async function fetchRealtimeData() {
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                
                // 1. Reset Counter
                let antrian = 0, proses = 0, selesai = 0;
                markerGroup.clearLayers();

                data.forEach(order => {
                    // Hitung Statistik
                    if(order.status === "Tunggu Antrian") antrian++;
                    if(order.status === "Proses") proses++;
                    if(order.status === "Selesai") selesai++;

                    // Warna Marker berdasarkan Status
                    let markerColor = "#f97316"; // Orange (Antrian)
                    let shadowClass = "";

                    if(order.status === "Proses") {
                        markerColor = "#3b82f6"; // Blue
                        shadowClass = "pulse-red"; // Kasih efek gerak untuk yang lagi dikerjain
                    }
                    if(order.status === "Selesai") markerColor = "#10b981"; // Green

                    // Tampilkan di Map jika ada koordinat
                    const lat = order.lat || order.lat_rumah;
                    const lng = order.lang || order.lang_rumah;

                    if(lat && lng) {
                        const icon = L.divIcon({
                            className: 'custom-marker',
                            html: `<div style="background:${markerColor}; width:20px; height:20px; border-radius:50%; border:3px solid white; box-shadow:0 4px 10px rgba(0,0,0,0.2);" class="${shadowClass}"></div>`
                        });

                        L.marker([lat, lng], {icon: icon})
                         .addTo(markerGroup)
                         .bindPopup(`<b>${order.nama_pelanggan}</b><br>${order.pekerjaan || order.layanan}<br>Status: ${order.status}`);
                    }
                });

                // Update UI Counter
                document.getElementById('countAntrian').innerText = antrian;
                document.getElementById('countProses').innerText = proses;
                document.getElementById('countSelesai').innerText = selesai;

            } catch (err) {
                console.error("Gagal update data:", err);
            }
        }

        window.onload = () => {
            initMap();
            fetchRealtimeData();
            // Auto refresh setiap 2 menit
            setInterval(fetchRealtimeData, 120000);
        };
    </script>
</body>
</html>
