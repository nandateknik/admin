<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Database Pelanggan - Nanda Teknik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1e293b; }
        .mobile-container { max-width: 480px; margin: 0 auto; background: white; min-height: 100vh; display: flex; flex-direction: column; position: relative; }
        .tab-active { color: #111827; font-weight: 900; border-bottom: 4px solid #111827; }
        #map, #mapEdit { height: 180px; border-radius: 1.5rem; border: 2px solid #f3f4f6; width: 100%; z-index: 1; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 10px; }
        .modal-blur { background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); }
    </style>
</head>
<body>

<div class="mobile-container shadow-2xl flex flex-col">
    
    <header class="p-8 pb-4 bg-white">
        <div class="flex items-center justify-between mb-6">
            <button onclick="window.location.href='dashboard.html'" class="bg-gray-100 p-3 rounded-2xl active:scale-90 transition-all">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </button>
            <h1 class="text-xl font-black text-gray-800">Database Pelanggan</h1>
            <div class="text-[10px] bg-blue-100 text-blue-600 px-3 py-1 rounded-full font-800 uppercase italic">CRM</div>
        </div>

        <nav class="flex border-b border-gray-100">
            <button onclick="switchTab('list')" id="tabList" class="flex-1 py-3 text-xs font-black tracking-widest tab-active uppercase transition-all">Daftar</button>
            <button onclick="switchTab('input')" id="tabInput" class="flex-1 py-3 text-xs font-black tracking-widest text-gray-300 uppercase transition-all">Tambah Baru</button>
        </nav>
    </header>

    <main id="contentList" class="px-8 pt-2 space-y-4 flex-1 pb-10 overflow-y-auto custom-scroll">
        <div class="mt-2">
            <input type="text" id="searchPelanggan" oninput="renderPelanggan()" placeholder="Cari nama atau email..." class="w-full bg-gray-50 border-2 border-gray-100 focus:border-blue-500 px-6 py-4 rounded-[2rem] font-bold text-gray-700 outline-none transition-all text-sm">
        </div>
        <div id="listPelanggan" class="space-y-3">
            </div>
    </main>

    <main id="contentInput" class="px-8 pt-2 hidden flex-1 pb-10">
        <form id="pelangganForm" class="space-y-5 bg-white p-2">
            <div>
                <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-2 mb-2 block">Data Diri</label>
                <input type="text" id="nama" required placeholder="Nama Lengkap" class="w-full bg-gray-50 border-2 border-gray-100 px-6 py-4 rounded-2xl font-bold text-gray-700 outline-none focus:border-blue-500 transition-all text-sm mb-3">
                <input type="number" id="whatsapp" required placeholder="WhatsApp (08...)" class="w-full bg-gray-50 border-2 border-gray-100 px-6 py-4 rounded-2xl font-bold text-gray-700 outline-none focus:border-blue-500 transition-all text-sm mb-3">
                <input type="email" id="email" required placeholder="Email Pelanggan" class="w-full bg-gray-50 border-2 border-gray-100 px-6 py-4 rounded-2xl font-bold text-gray-700 outline-none focus:border-blue-500 transition-all text-sm">
            </div>

            <div>
                <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-2 mb-2 block">Pin Lokasi</label>
                <div id="map" class="mb-3 shadow-sm"></div>
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="lat" readonly class="bg-gray-100 px-4 py-3 rounded-xl text-[10px] font-black text-gray-500 outline-none">
                    <input type="text" id="lang" readonly class="bg-gray-100 px-4 py-3 rounded-xl text-[10px] font-black text-gray-500 outline-none">
                </div>
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-gray-900 text-white py-5 rounded-[2rem] font-black shadow-xl active:scale-95 transition-all mt-4 uppercase tracking-widest text-xs">Simpan Data Pelanggan</button>
        </form>
    </main>
</div>

<div id="modalEdit" class="fixed inset-0 z-[100] hidden items-center justify-center p-6 modal-blur">
    <div class="bg-white w-full max-w-sm rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
        <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50">
            <h2 class="text-xs font-black uppercase tracking-widest">Update Pelanggan</h2>
            <button onclick="tutupModal()" class="text-gray-400 font-black">✕</button>
        </div>
        <div class="p-8 overflow-y-auto custom-scroll">
            <form id="editForm" class="space-y-4">
                <input type="hidden" id="edit_original_email">
                <input type="text" id="edit_nama" required placeholder="Nama" class="w-full bg-gray-50 border-2 border-gray-100 px-5 py-3.5 rounded-2xl font-bold text-sm outline-none focus:border-orange-500">
                <input type="number" id="edit_whatsapp" required placeholder="WA" class="w-full bg-gray-50 border-2 border-gray-100 px-5 py-3.5 rounded-2xl font-bold text-sm outline-none focus:border-orange-500">
                <input type="email" id="edit_email" required placeholder="Email" class="w-full bg-gray-50 border-2 border-gray-100 px-5 py-3.5 rounded-2xl font-bold text-sm outline-none focus:border-orange-500">
                
                <div id="mapEdit" class="my-4 shadow-inner"></div>
                
                <div class="grid grid-cols-2 gap-2 mb-6">
                    <input type="text" id="edit_lat" readonly class="bg-gray-100 px-3 py-2 rounded-lg text-[9px] font-bold text-gray-400">
                    <input type="text" id="edit_lang" readonly class="bg-gray-100 px-3 py-2 rounded-lg text-[9px] font-bold text-gray-400">
                </div>

                <button type="submit" id="updateBtn" class="w-full bg-orange-500 text-white py-4 rounded-2xl font-black shadow-lg shadow-orange-100 active:scale-95 transition-all uppercase tracking-widest text-[10px]">Simpan Perubahan</button>
            </form>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwJNUwkMUrNtp5JcsVq7P-Vh2MT1AOhJTeRlMVhYIGSUU2IYhSvQBRh_bBTWrdoiZr7VA/exec";
    let dbPelanggan = [], map, marker, mapEdit, markerEdit;

    window.onload = () => {
        initMap();
        fetchPelanggan();
    };

    function switchTab(tab) {
        document.getElementById('contentList').classList.toggle('hidden', tab !== 'list');
        document.getElementById('contentInput').classList.toggle('hidden', tab !== 'input');
        
        document.getElementById('tabList').classList.toggle('tab-active', tab === 'list');
        document.getElementById('tabList').classList.toggle('text-gray-300', tab !== 'list');
        document.getElementById('tabInput').classList.toggle('tab-active', tab === 'input');
        document.getElementById('tabInput').classList.toggle('text-gray-300', tab !== 'input');
        
        if(tab === 'input') setTimeout(() => map.invalidateSize(), 200);
    }

    function initMap() {
        // Map Input
        map = L.map('map').setView([-8.2191, 114.3691], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
        marker = L.marker([-8.2191, 114.3691], {draggable: true}).addTo(map);
        marker.on('dragend', e => {
            document.getElementById('lat').value = e.target.getLatLng().lat.toFixed(6);
            document.getElementById('lang').value = e.target.getLatLng().lng.toFixed(6);
        });

        // Map Edit (Modal)
        mapEdit = L.map('mapEdit').setView([-8.2191, 114.3691], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(mapEdit);
        markerEdit = L.marker([-8.2191, 114.3691], {draggable: true}).addTo(mapEdit);
        markerEdit.on('dragend', e => {
            document.getElementById('edit_lat').value = e.target.getLatLng().lat.toFixed(6);
            document.getElementById('edit_lang').value = e.target.getLatLng().lng.toFixed(6);
        });
    }

    async function fetchPelanggan() {
        const container = document.getElementById('listPelanggan');
        container.innerHTML = `<p class="text-center py-10 text-gray-400 font-black text-[10px] uppercase animate-pulse">Loading Database...</p>`;
        try {
            const res = await fetch(SCRIPT_URL + "?type=pelanggan");
            dbPelanggan = await res.json();
            renderPelanggan();
        } catch (e) { container.innerHTML = `<p class="text-red-500 text-center font-black text-[10px] uppercase">Gagal Sinkronisasi</p>`; }
    }

    function renderPelanggan() {
        const container = document.getElementById('listPelanggan');
        const searchVal = document.getElementById('searchPelanggan').value.toLowerCase();
        const filtered = dbPelanggan.filter(p => p.nama.toLowerCase().includes(searchVal) || p.email.toLowerCase().includes(searchVal));
        
        container.innerHTML = filtered.map((p, idx) => `
            <div onclick="bukaEditModal(${idx})" class="bg-white p-5 rounded-[2rem] border-2 border-gray-50 flex justify-between items-center shadow-sm active:scale-95 transition-all">
                <div>
                    <h3 class="font-black text-gray-800 text-xs uppercase">${p.nama}</h3>
                    <p class="text-[9px] font-black text-gray-400 mt-1 uppercase tracking-tighter">${p.whatsapp} • ${p.email}</p>
                </div>
                <div class="bg-gray-50 p-2 rounded-xl text-gray-300">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </div>
            </div>
        `).join('');
    }

    function bukaEditModal(idx) {
        const p = dbPelanggan[idx];
        document.getElementById('edit_original_email').value = p.email;
        document.getElementById('edit_nama').value = p.nama;
        document.getElementById('edit_email').value = p.email;
        document.getElementById('edit_whatsapp').value = p.whatsapp;
        document.getElementById('edit_lat').value = p.lat;
        document.getElementById('edit_lang').value = p.lang || p.lng;

        document.getElementById('modalEdit').classList.replace('hidden', 'flex');
        setTimeout(() => {
            mapEdit.invalidateSize();
            const coords = [parseFloat(p.lat), parseFloat(p.lang || p.lng)];
            mapEdit.setView(coords, 16);
            markerEdit.setLatLng(coords);
        }, 300);
    }

    function tutupModal() { document.getElementById('modalEdit').classList.replace('flex', 'hidden'); }

    async function handlePost(formId, action) {
        const form = document.getElementById(formId);
        const btn = form.querySelector('button[type="submit"]');
        btn.disabled = true; btn.innerText = "SEDANG MEMPROSES...";

        const payload = {
            action: action,
            nama: form.querySelector('[id*="nama"]').value,
            email: form.querySelector('[id*="email"]').value,
            whatsapp: form.querySelector('[id*="whatsapp"]').value,
            lat: form.querySelector('[id*="lat"]').value,
            lang: form.querySelector('[id*="lang"]').value,
            original_email: document.getElementById('edit_original_email').value,
            tanggal: new Date().toLocaleDateString('id-ID'),
            is_active: "TRUE"
        };

        try {
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            Swal.fire({ icon: 'success', title: 'BERHASIL', text: 'Data wis diupdate, Bos!', confirmButtonColor: '#111827' });
            if(action === 'updatePelanggan') tutupModal();
            form.reset();
            fetchPelanggan();
            if(action === 'tambahPelanggan') switchTab('list');
        } catch (e) { Swal.fire('Gagal', 'Sistem error.', 'error'); }
        finally { btn.disabled = false; btn.innerText = action === 'updatePelanggan' ? "SIMPAN PERUBAHAN" : "SIMPAN DATA PELANGGAN"; }
    }

    document.getElementById('pelangganForm').onsubmit = (e) => { e.preventDefault(); handlePost('pelangganForm', 'tambahPelanggan'); };
    document.getElementById('editForm').onsubmit = (e) => { e.preventDefault(); handlePost('editForm', 'updatePelanggan'); };
</script>
</body>
</html>
