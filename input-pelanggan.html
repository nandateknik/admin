<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Pelanggan - Nanda Teknik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-active { background: #111827; color: white; }
        #map, #mapEdit { height: 200px; border-radius: 1.5rem; border: 2px solid #f3f4f6; width: 100%; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 10px; }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="max-w-5xl mx-auto">
        <div class="flex items-center justify-between mb-8 bg-white p-6 rounded-[2rem] shadow-sm">
            <div>
                <h1 class="text-2xl font-black text-gray-800 uppercase italic">Database <span class="text-blue-500">Pelanggan</span></h1>
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Nanda Teknik Management System</p>
            </div>
            <button onclick="window.location.href='index.html'" class="bg-gray-900 text-white px-6 py-3 rounded-2xl font-black text-xs uppercase tracking-widest active:scale-95 transition-all">Kembali</button>
        </div>

        <div class="flex bg-white p-2 rounded-3xl shadow-sm mb-6 max-w-md mx-auto">
            <button id="tabList" onclick="switchTab('list')" class="flex-1 py-4 rounded-2xl font-black text-xs uppercase tracking-widest tab-active transition-all">Daftar Pelanggan</button>
            <button id="tabInput" onclick="switchTab('input')" class="flex-1 py-4 rounded-2xl font-black text-xs uppercase tracking-widest text-gray-400 transition-all">Tambah Baru</button>
        </div>

        <div id="sectionList" class="space-y-4">
            <div class="bg-white p-4 rounded-3xl shadow-sm border border-gray-100">
                <input type="text" id="searchPelanggan" oninput="renderPelanggan()" placeholder="Cari nama atau email..." class="w-full bg-gray-50 border-2 border-gray-50 focus:border-blue-500 px-6 py-4 rounded-2xl font-bold text-gray-700 outline-none transition-all text-sm">
            </div>
            <div id="listPelanggan" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                </div>
        </div>

        <div id="sectionInput" class="hidden max-w-xl mx-auto">
            <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-gray-100">
                <form id="pelangganForm" class="space-y-4">
                    <div>
                        <label class="text-[9px] font-black text-gray-400 uppercase ml-3 mb-1 block">Nama Lengkap</label>
                        <input type="text" id="nama" required class="w-full bg-gray-50 border-2 border-gray-50 focus:border-blue-500 px-5 py-3.5 rounded-2xl font-bold text-gray-700 outline-none text-sm">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="whatsapp" required placeholder="WA (0812...)" class="w-full bg-gray-50 border-2 border-gray-50 focus:border-blue-500 px-5 py-3.5 rounded-2xl font-bold text-gray-700 outline-none text-sm">
                        <input type="email" id="email" required placeholder="Email" class="w-full bg-gray-50 border-2 border-gray-50 focus:border-blue-500 px-5 py-3.5 rounded-2xl font-bold text-gray-700 outline-none text-sm">
                    </div>
                    <div id="map"></div>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="lat" readonly class="bg-gray-100 px-4 py-2 rounded-xl text-[10px] font-bold text-gray-500">
                        <input type="text" id="lang" readonly class="bg-gray-100 px-4 py-2 rounded-xl text-[10px] font-bold text-gray-500">
                    </div>
                    <button type="submit" id="submitBtn" class="w-full bg-blue-500 text-white py-5 rounded-[2rem] font-black shadow-lg shadow-blue-100 active:scale-95 transition-all mt-4 uppercase tracking-widest text-xs">Simpan Pelanggan</button>
                </form>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xl rounded-[2.5rem] shadow-2xl p-8 relative max-h-[90vh] overflow-y-auto custom-scroll">
            <button onclick="closeModal()" class="absolute top-6 right-6 text-gray-400 hover:text-red-500 transition-all font-black">CLOSE</button>
            <h2 class="text-sm font-black text-gray-800 uppercase tracking-widest mb-6">Update Data Pelanggan</h2>
            
            <form id="editForm" class="space-y-4">
                <input type="hidden" id="edit_original_email">
                <input type="text" id="edit_nama" required placeholder="Nama" class="w-full bg-gray-50 border-2 border-gray-50 focus:border-orange-500 px-5 py-3.5 rounded-2xl font-bold text-gray-700 outline-none text-sm">
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="edit_whatsapp" required placeholder="WA" class="w-full bg-gray-50 border-2 border-gray-50 focus:border-orange-500 px-5 py-3.5 rounded-2xl font-bold text-gray-700 outline-none text-sm">
                    <input type="email" id="edit_email" required placeholder="Email" class="w-full bg-gray-50 border-2 border-gray-50 focus:border-orange-500 px-5 py-3.5 rounded-2xl font-bold text-gray-700 outline-none text-sm">
                </div>
                <div id="mapEdit"></div>
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="edit_lat" readonly class="bg-gray-100 px-4 py-2 rounded-xl text-[10px] font-bold text-gray-500">
                    <input type="text" id="edit_lang" readonly class="bg-gray-100 px-4 py-2 rounded-xl text-[10px] font-bold text-gray-500">
                </div>
                <button type="submit" id="updateBtn" class="w-full bg-orange-500 text-white py-5 rounded-[2rem] font-black shadow-lg shadow-orange-100 active:scale-95 transition-all mt-4 uppercase tracking-widest text-xs">Simpan Perubahan</button>
            </form>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwJNUwkMUrNtp5JcsVq7P-Vh2MT1AOhJTeRlMVhYIGSUU2IYhSvQBRh_bBTWrdoiZr7VA/exec";
        let dbPelanggan = [], map, marker, mapEdit, markerEdit;

        window.onload = () => {
            initMap();
            fetchPelanggan();
        };

        function switchTab(type) {
            const isList = type === 'list';
            document.getElementById('sectionList').classList.toggle('hidden', !isList);
            document.getElementById('sectionInput').classList.toggle('hidden', isList);
            document.getElementById('tabList').className = isList ? 'flex-1 py-4 rounded-2xl font-black text-xs uppercase tracking-widest tab-active' : 'flex-1 py-4 rounded-2xl font-black text-xs uppercase tracking-widest text-gray-400';
            document.getElementById('tabInput').className = !isList ? 'flex-1 py-4 rounded-2xl font-black text-xs uppercase tracking-widest tab-active' : 'flex-1 py-4 rounded-2xl font-black text-xs uppercase tracking-widest text-gray-400';
            if(!isList) setTimeout(() => map.invalidateSize(), 200);
        }

        function initMap() {
            // Map Input
            map = L.map('map').setView([-8.2191, 114.3691], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            marker = L.marker([-8.2191, 114.3691], {draggable: true}).addTo(map);
            marker.on('dragend', e => {
                document.getElementById('lat').value = e.target.getLatLng().lat.toFixed(6);
                document.getElementById('lang').value = e.target.getLatLng().lng.toFixed(6);
            });

            // Map Edit (Modal)
            mapEdit = L.map('mapEdit').setView([-8.2191, 114.3691], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(mapEdit);
            markerEdit = L.marker([-8.2191, 114.3691], {draggable: true}).addTo(mapEdit);
            markerEdit.on('dragend', e => {
                document.getElementById('edit_lat').value = e.target.getLatLng().lat.toFixed(6);
                document.getElementById('edit_lang').value = e.target.getLatLng().lng.toFixed(6);
            });
        }

        async function fetchPelanggan() {
            const container = document.getElementById('listPelanggan');
            container.innerHTML = `<p class="col-span-full text-center py-10 text-gray-400 font-black text-[10px] uppercase animate-pulse">Sinkronisasi Database...</p>`;
            try {
                const res = await fetch(SCRIPT_URL + "?type=pelanggan");
                dbPelanggan = await res.json();
                renderPelanggan();
            } catch (e) { container.innerHTML = `<p class="text-red-500 text-center col-span-full uppercase font-black text-xs">Gagal Load Data</p>`; }
        }

        function renderPelanggan() {
            const container = document.getElementById('listPelanggan');
            const searchVal = document.getElementById('searchPelanggan').value.toLowerCase();
            const filtered = dbPelanggan.filter(p => p.nama.toLowerCase().includes(searchVal) || p.email.toLowerCase().includes(searchVal));
            
            container.innerHTML = filtered.map((p, idx) => `
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-transparent hover:border-blue-500 transition-all flex justify-between items-center group">
                    <div>
                        <h3 class="font-black text-gray-800 uppercase text-xs">${p.nama}</h3>
                        <p class="text-[10px] font-bold text-gray-400 mt-1 uppercase tracking-tighter">${p.whatsapp} â€¢ ${p.email}</p>
                    </div>
                    <button onclick="openEditModal(${idx})" class="bg-gray-100 p-3 rounded-2xl group-hover:bg-blue-500 group-hover:text-white transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                    </button>
                </div>
            `).join('');
        }

        function openEditModal(index) {
            const p = dbPelanggan[index];
            document.getElementById('edit_original_email').value = p.email;
            document.getElementById('edit_nama').value = p.nama;
            document.getElementById('edit_email').value = p.email;
            document.getElementById('edit_whatsapp').value = p.whatsapp;
            document.getElementById('edit_lat').value = p.lat;
            document.getElementById('edit_lang').value = p.lang || p.lng;

            document.getElementById('editModal').style.display = 'flex';
            setTimeout(() => {
                mapEdit.invalidateSize();
                const coords = [parseFloat(p.lat), parseFloat(p.lang || p.lng)];
                mapEdit.setView(coords, 16);
                markerEdit.setLatLng(coords);
            }, 300);
        }

        function closeModal() { document.getElementById('editModal').style.display = 'none'; }

        // Logic Simpan (Post) sisan tak gabung kene
        async function handlePost(formId, action) {
            const form = document.getElementById(formId);
            const btn = form.querySelector('button[type="submit"]');
            const oldText = btn.innerText;
            btn.disabled = true; btn.innerText = "PROSES...";

            const payload = {
                action: action,
                nama: form.querySelector('[id*="nama"]').value,
                email: form.querySelector('[id*="email"]').value,
                whatsapp: form.querySelector('[id*="whatsapp"]').value,
                lat: form.querySelector('[id*="lat"]').value,
                lang: form.querySelector('[id*="lang"]').value,
                original_email: document.getElementById('edit_original_email').value,
                tanggal: new Date().toLocaleDateString('id-ID'),
                is_active: "TRUE"
            };

            try {
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                Swal.fire('BERHASIL', 'Data wis kesimpen, Bos!', 'success');
                if(action === 'updatePelanggan') closeModal();
                form.reset();
                fetchPelanggan();
                if(action === 'tambahPelanggan') switchTab('list');
            } catch (e) { Swal.fire('Gagal', 'Sistem error, jajal maneh.', 'error'); }
            finally { btn.disabled = false; btn.innerText = oldText; }
        }

        document.getElementById('pelangganForm').onsubmit = (e) => { e.preventDefault(); handlePost('pelangganForm', 'tambahPelanggan'); };
        document.getElementById('editForm').onsubmit = (e) => { e.preventDefault(); handlePost('editForm', 'updatePelanggan'); };
    </script>
</body>
</html>
