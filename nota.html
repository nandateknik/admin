<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Billing System - Nanda Teknik</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=Courier+Prime&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; overflow-x: hidden; }
        .mobile-container { max-width: 480px; margin: 0 auto; background: white; min-height: 100vh; position: relative; border-left: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; }
        
        /* SIDEBAR (Sama dengan Dashboard) */
        #sidebar { position: absolute; top: 0; left: -110%; width: 280px; height: 100%; background: white; z-index: 5000; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; box-shadow: 20px 0 50px rgba(0,0,0,0.1); }
        #sidebar.open { left: 0; }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 12px; color: #64748b; font-weight: 700; font-size: 0.85rem; transition: 0.2s; cursor: pointer; text-decoration: none; }
        .nav-link:hover { background: #f1f5f9; color: #2563eb; }
        .nav-link.active { background: #2563eb; color: white; }
        .logout-btn { color: #ef4444 !important; border-top: 1px solid #f1f5f9; margin-top: auto; padding: 20px 16px; }
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.2); z-index: 4999; display: none; backdrop-filter: blur(2px); }

        /* TAB STYLE */
        .tab-btn { position: relative; font-weight: 800; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; transition: 0.3s; }
        .tab-btn.active { color: #1e293b; }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 20px; height: 4px; background: #2563eb; border-radius: 10px; }

        /* AUTOCOMPLETE */
        .autocomplete-items { position: absolute; background: white; z-index: 2000; top: 100%; left: 0; right: 0; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; }
        .autocomplete-item { padding: 12px 20px; cursor: pointer; border-bottom: 1px solid #f1f5f9; }
        .autocomplete-item:hover { background: #f8fafc; }

        /* NOTA KERTAS */
        .nota-kertas { font-family: 'Courier Prime', monospace; color: black; background: white; }
        #watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg); z-index: 10; opacity: 0.2; pointer-events: none; }
    </style>
</head>
<body>

<div class="mobile-container shadow-2xl">
    <div id="overlay" onclick="toggleSidebar()"></div>

    <div id="sidebar">
        <div class="p-6 flex flex-col h-full">
            <div class="flex items-center gap-3 mb-8">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white font-black shadow-lg">N</div>
                <h1 class="font-extrabold text-slate-800 tracking-tight italic text-lg">NANDA <span class="text-blue-600">TEKNIK</span></h1>
            </div>
            <nav class="space-y-1 flex-1">
                <p class="text-[10px] font-bold text-slate-400 uppercase ml-3 mb-2 tracking-widest">Utama</p>
                <a href="dashboard.html" class="nav-link">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                    Homepage
                </a>
                <a href="pelanggan.html" class="nav-link">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                    Database Pelanggan
                </a>
                <p class="text-[10px] font-bold text-slate-400 uppercase ml-3 mt-6 mb-2 tracking-widest">Transaksi & Marketing</p>
                <a href="input-booking.html" class="nav-link">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
                    Input Booking
                </a>
                <a href="nota.html" class="nav-link active">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    Billing System
                </a>
            </nav>
            <div onclick="logout()" class="nav-link logout-btn">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                Logout Admin
            </div>
        </div>
    </div>

    <header class="p-6 bg-white border-b border-slate-100 sticky top-0 z-[100]">
        <div class="flex items-center justify-between mb-6">
            <button onclick="toggleSidebar()" class="p-2 bg-slate-50 rounded-xl text-slate-600 active:scale-90 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
            </button>
            <h1 class="font-extrabold text-slate-800 text-lg">Billing System</h1>
            <span class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-[10px] font-black italic shadow-sm">v2.5</span>
        </div>
        <div class="flex gap-8 px-2">
            <button onclick="switchTab('buat')" id="tabBuat" class="tab-btn active">Buat Nota</button>
            <button onclick="switchTab('riwayat')" id="tabRiwayat" class="tab-btn">Riwayat Nota</button>
        </div>
    </header>

    <main id="contentBuat" class="p-6 space-y-6 pb-24">
        <div class="relative">
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2 ml-1">Nama Pelanggan / Email</label>
            <input type="text" id="notaCustSearch" placeholder="Cari pelanggan..." autocomplete="off" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-5 py-4 font-bold text-slate-700 outline-none focus:border-blue-500 transition-all">
            <div id="autocomplete-list" class="autocomplete-items hidden border border-slate-100"></div>
            <input type="hidden" id="finalEmail">
        </div>

        <div id="itemContainer" class="space-y-4">
            <div class="bg-white border-2 border-slate-100 p-5 rounded-3xl space-y-4 item-row shadow-sm">
                <input type="text" placeholder="Deskripsi Jasa / Barang" class="w-full text-sm font-bold outline-none item-nama border-b border-slate-100 pb-2 focus:border-blue-400 transition-all">
                <div class="flex gap-4">
                    <div class="w-20">
                        <label class="text-[9px] font-black text-slate-400 uppercase block mb-1">Qty</label>
                        <input type="number" oninput="hitungTotal()" value="1" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-black item-qty outline-none">
                    </div>
                    <div class="flex-1">
                        <label class="text-[9px] font-black text-slate-400 uppercase block mb-1">Harga Satuan</label>
                        <input type="number" oninput="hitungTotal()" placeholder="0" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-black item-harga text-right outline-none">
                    </div>
                </div>
            </div>
        </div>

        <button onclick="tambahItem()" class="w-full py-4 border-2 border-dashed border-slate-200 rounded-2xl text-[10px] font-black text-slate-400 uppercase tracking-widest hover:bg-slate-50 transition">+ Tambah Baris Pekerjaan</button>

        <div class="fixed bottom-0 left-0 right-0 max-w-[480px] mx-auto p-6 bg-white/80 backdrop-blur-md border-t border-slate-100 z-[1000]">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Total Tagihan</p>
                    <span id="totalDisplay" class="text-xl font-black text-slate-900">Rp 0</span>
                </div>
                <div class="flex gap-2">
                    <select id="notaStatus" class="bg-slate-100 text-[10px] font-black px-3 py-4 rounded-xl outline-none text-slate-600">
                        <option value="PAID">LUNAS</option>
                        <option value="UNPAID">PIUTANG</option>
                    </select>
                    <button onclick="simpanNota()" class="bg-blue-600 text-white px-8 py-4 rounded-xl font-black text-xs uppercase shadow-lg active:scale-95 transition">Simpan</button>
                </div>
            </div>
        </div>
    </main>

    <main id="contentRiwayat" class="hidden p-6 pb-24 space-y-4">
        <input type="text" id="searchRiwayat" oninput="renderRiwayat()" placeholder="Cari nota atau nama..." class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl text-xs font-bold outline-none focus:border-blue-500">
        <div id="listRiwayat" class="space-y-4 min-h-[400px]"></div>
        
        <div class="flex items-center justify-between pt-4">
            <button onclick="prevPage()" class="p-3 bg-white border border-slate-200 rounded-xl text-slate-600 active:scale-90 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7"/></svg>
            </button>
            <span id="pageNumber" class="text-[10px] font-black text-slate-400 uppercase">Halaman 1</span>
            <button onclick="nextPage()" class="p-3 bg-white border border-slate-200 rounded-xl text-slate-600 active:scale-90 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"/></svg>
            </button>
        </div>
    </main>
</div>

<div id="modalNota" class="fixed inset-0 bg-slate-900/90 z-[9999] hidden items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white w-full max-w-2xl rounded-3xl overflow-hidden flex flex-col shadow-2xl max-h-[95vh]">
        <div class="p-4 bg-slate-50 flex justify-between items-center border-b border-slate-200">
            <div class="flex gap-2">
                <button onclick="unduhPDF()" class="bg-blue-600 text-white px-4 py-2.5 rounded-xl text-[10px] font-black uppercase shadow-lg">Cetak PDF</button>
                <button onclick="tutupModal()" class="bg-white border border-slate-200 px-4 py-2.5 rounded-xl text-[10px] font-black uppercase">Tutup</button>
            </div>
            <div id="modalBadge" class="px-4 py-2 rounded-lg text-[10px] font-black"></div>
        </div>
        
        <div id="notaPrintArea" class="p-10 nota-kertas overflow-y-auto relative">
            <div id="watermark"></div>
            <div class="text-center mb-10 border-b-2 border-slate-900 pb-6">
                <h2 class="font-black text-2xl uppercase tracking-tighter mb-1">NANDA TEKNIK BANYUWANGI</h2>
                <p class="text-[10px] font-bold">Network, Software & Electrical Engineering</p>
                <p class="text-[9px] text-slate-600 mt-1 italic">Sukowidi Indah Residence, Blok D-5 Banyuwangi • WA: 0823-3120-1148</p>
            </div>

            <div class="grid grid-cols-2 text-[11px] mb-8 leading-relaxed">
                <div class="space-y-1">
                    <p><span class="inline-block w-16 font-bold uppercase">No. Inv</span>: <span id="invId" class="font-black"></span></p>
                    <p><span class="inline-block w-16 font-bold uppercase">Customer</span>: <span id="invCust" class="font-black"></span></p>
                </div>
                <div class="text-right space-y-1">
                    <p><span class="font-bold uppercase">Tanggal</span>: <span id="invTgl"></span></p>
                </div>
            </div>

            <table class="w-full text-[11px] mb-10 border-t-2 border-b-2 border-slate-900">
                <thead>
                    <tr class="bg-slate-50 border-b border-slate-900 font-black uppercase">
                        <th class="py-3 px-4 text-left">Deskripsi Pekerjaan</th>
                        <th class="py-3 px-2 text-center w-12">Qty</th>
                        <th class="py-3 px-4 text-right w-24">Harga</th>
                        <th class="py-3 px-4 text-right w-32">Subtotal</th>
                    </tr>
                </thead>
                <tbody id="invItems"></tbody>
                <tfoot>
                    <tr class="font-black border-t border-slate-900 text-sm">
                        <td colspan="3" class="py-4 px-4 text-right uppercase tracking-widest">Total Akhir</td>
                        <td class="py-4 px-4 text-right" id="invTotal"></td>
                    </tr>
                </tfoot>
            </table>

            <div class="flex justify-between items-end mt-12">
                <div class="border-2 border-dashed border-slate-300 p-4 rounded-xl w-64">
                    <p class="text-[9px] font-black uppercase mb-2">Metode Pembayaran:</p>
                    <p class="text-[10px] text-slate-600">Bank BCA - Nanda Krisbianto</p>
                    <p class="text-[11px] font-black mt-1 underline">Rek: 180-182-6011</p>
                </div>
                <div class="text-center w-40">
                    <p class="text-[10px] font-bold mb-16">Hormat Kami,</p>
                    <p class="text-[11px] font-black uppercase underline">( NANDA KRISBIANTO )</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzg5RTkyWU_SlYftvpx3bEPGuaknDOaoJrtJv2dXJ1Ysn5FyWGv4z-YyI5sgidoLTCZuw/exec";
    let pelangganData = [], databaseNota = [], selectedNota = null;
    let currentPage = 1, rowsPerPage = 5;

    function toggleSidebar() {
        const sb = document.getElementById('sidebar');
        const ov = document.getElementById('overlay');
        sb.classList.toggle('open');
        ov.style.display = sb.classList.contains('open') ? 'block' : 'none';
    }

    async function init() {
        try {
            const resP = await fetch(SCRIPT_URL + "?type=pelanggan");
            pelangganData = await resP.json();
            loadRiwayat();
        } catch (e) { console.error(e); }
    }

    function switchTab(tab) {
        document.getElementById('contentBuat').classList.toggle('hidden', tab !== 'buat');
        document.getElementById('contentRiwayat').classList.toggle('hidden', tab !== 'riwayat');
        document.getElementById('tabBuat').className = tab === 'buat' ? 'tab-btn active' : 'tab-btn';
        document.getElementById('tabRiwayat').className = tab === 'riwayat' ? 'tab-btn active' : 'tab-btn';
    }

    // AUTOCOMPLETE PELANGGAN
    const searchInput = document.getElementById('notaCustSearch');
    const autoList = document.getElementById('autocomplete-list');

    searchInput.addEventListener('input', function() {
        const val = this.value;
        autoList.innerHTML = "";
        if (!val) { autoList.classList.add('hidden'); return; }
        const filtered = pelangganData.filter(p => (p.nama && p.nama.toLowerCase().includes(val.toLowerCase())));
        if(filtered.length > 0) {
            filtered.forEach(p => {
                const div = document.createElement('div');
                div.className = "autocomplete-item font-bold text-sm text-slate-700";
                div.innerHTML = `${p.nama} <span class="text-[9px] text-slate-400 font-black ml-2 uppercase">${p.email}</span>`;
                div.onclick = () => {
                    searchInput.value = p.nama;
                    document.getElementById('finalEmail').value = p.email;
                    autoList.classList.add('hidden');
                };
                autoList.appendChild(div);
            });
            autoList.classList.remove('hidden');
        }
    });

    function tambahItem() {
        const div = document.createElement('div');
        div.className = "bg-white border-2 border-slate-100 p-5 rounded-3xl space-y-4 item-row relative shadow-sm animate-fade-in";
        div.innerHTML = `<button onclick="this.parentElement.remove(); hitungTotal();" class="absolute top-4 right-4 text-slate-300">✕</button>
            <input type="text" placeholder="Deskripsi Jasa" class="w-full text-sm font-bold outline-none item-nama border-b border-slate-100 pb-2 focus:border-blue-400 transition-all">
            <div class="flex gap-4">
                <div class="w-20"><input type="number" oninput="hitungTotal()" value="1" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-black item-qty outline-none"></div>
                <div class="flex-1"><input type="number" oninput="hitungTotal()" placeholder="0" class="w-full bg-slate-50 p-3 rounded-xl text-sm font-black item-harga text-right outline-none"></div>
            </div>`;
        document.getElementById('itemContainer').appendChild(div);
    }

    function hitungTotal() {
        let total = 0;
        document.querySelectorAll('.item-row').forEach(row => {
            const q = parseFloat(row.querySelector('.item-qty').value) || 0;
            const h = parseFloat(row.querySelector('.item-harga').value) || 0;
            total += (q * h);
        });
        document.getElementById('totalDisplay').innerText = "Rp " + total.toLocaleString('id-ID');
        return total;
    }

    async function simpanNota() {
        const custName = searchInput.value;
        const custEmail = document.getElementById('finalEmail').value || custName;
        if(!custName) return Swal.fire('Error', 'Nama pelanggan wajib diisi', 'error');

        const items = [];
        document.querySelectorAll('.item-row').forEach(row => {
            const n = row.querySelector('.item-nama').value;
            const q = row.querySelector('.item-qty').value;
            const h = row.querySelector('.item-harga').value;
            if(n && h) items.push({ nama: n, qty: q, harga: h });
        });

        if(items.length === 0) return Swal.fire('Error', 'Baris pekerjaan kosong', 'error');

        const payload = {
            action: 'simpanNota',
            id_nota: "INV-" + Date.now().toString().slice(-6),
            email: custEmail,
            items: JSON.stringify(items),
            total: hitungTotal(),
            status: document.getElementById('notaStatus').value,
            tanggal: new Date().toLocaleDateString('id-ID')
        };

        Swal.fire({title: 'Menyimpan...', didOpen: () => Swal.showLoading()});
        await fetch(SCRIPT_URL, {method: 'POST', mode: 'no-cors', body: JSON.stringify(payload)});
        Swal.fire('Sukses', 'Nota tersimpan!', 'success').then(() => location.reload());
    }

    async function loadRiwayat() {
        try {
            const res = await fetch(SCRIPT_URL + "?type=nota");
            databaseNota = await res.json();
            renderRiwayat();
        } catch (e) { console.error(e); }
    }

    function renderRiwayat() {
        const container = document.getElementById('listRiwayat');
        const query = document.getElementById('searchRiwayat').value.toLowerCase();
        
        let filtered = databaseNota.slice().reverse().filter(n => 
            (n.email && n.email.toLowerCase().includes(query)) || 
            (n.id_nota && n.id_nota.toLowerCase().includes(query))
        );

        const start = (currentPage - 1) * rowsPerPage;
        const paginated = filtered.slice(start, start + rowsPerPage);
        
        container.innerHTML = "";
        paginated.forEach(n => {
            const isPaid = n.status === 'PAID';
            container.innerHTML += `
                <div onclick='bukaDetail(${JSON.stringify(n)})' class="bg-white p-5 rounded-3xl border border-slate-100 flex justify-between items-center shadow-sm active:scale-95 transition cursor-pointer">
                    <div>
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-tighter">${n.id_nota || n.id} • ${n.tanggal}</p>
                        <p class="text-sm font-extrabold text-slate-800">${n.email}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-black text-slate-900">Rp ${parseInt(n.total).toLocaleString()}</p>
                        <span class="text-[9px] font-black px-2 py-0.5 rounded-md uppercase ${isPaid?'bg-green-100 text-green-600':'bg-red-100 text-red-600'}">${n.status}</span>
                    </div>
                </div>`;
        });
        document.getElementById('pageNumber').innerText = `Halaman ${currentPage}`;
    }

    function nextPage() { if(currentPage * rowsPerPage < databaseNota.length) { currentPage++; renderRiwayat(); } }
    function prevPage() { if(currentPage > 1) { currentPage--; renderRiwayat(); } }

    function bukaDetail(n) {
        selectedNota = n;
        document.getElementById('invId').innerText = n.id_nota || n.id;
        document.getElementById('invCust').innerText = n.email;
        document.getElementById('invTgl').innerText = n.tanggal;
        document.getElementById('invTotal').innerText = "Rp " + parseInt(n.total).toLocaleString('id-ID');
        
        const badge = document.getElementById('modalBadge');
        badge.innerText = n.status;
        badge.className = `px-4 py-2 rounded-lg text-[10px] font-black uppercase ${n.status === 'PAID' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`;

        const wm = document.getElementById('watermark');
        wm.innerHTML = `<span style="border: 4px solid ${n.status==='PAID'?'#16a34a':'#ef4444'}; color:${n.status==='PAID'?'#16a34a':'#ef4444'}; padding:10px 20px; border-radius:12px; font-size:40px; font-weight:900;">${n.status}</span>`;

        const b = document.getElementById('invItems');
        b.innerHTML = "";
        let items = [];
        try { items = typeof n.items === 'string' ? JSON.parse(n.items) : n.items; } catch(e) {}
        
        items.forEach(it => {
            b.innerHTML += `
                <tr class="border-b border-slate-100">
                    <td class="py-4 px-4 text-left font-bold text-slate-700 uppercase">${it.nama}</td>
                    <td class="text-center font-black">${it.qty}</td>
                    <td class="text-right px-4">${parseInt(it.harga).toLocaleString()}</td>
                    <td class="text-right px-4 font-black text-slate-900">${(it.qty * it.harga).toLocaleString()}</td>
                </tr>`;
        });
        document.getElementById('modalNota').classList.replace('hidden', 'flex');
    }

    function unduhPDF() {
        const el = document.getElementById('notaPrintArea');
        const opt = { margin: 10, filename: `Nota-${selectedNota.id_nota}.pdf`, html2canvas: { scale: 3 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
        html2pdf().from(el).set(opt).save();
    }

    function tutupModal() { document.getElementById('modalNota').classList.replace('flex', 'hidden'); }
    function logout() { localStorage.removeItem('isLoggedIn'); window.location.href='login.html'; }

    window.onload = init;
</script>
</body>
</html>
