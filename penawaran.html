<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Penawaran & Email - Nanda Teknik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Courier+Prime&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        .tab-active { border-bottom: 3px solid #111827; color: #111827; }
        .nota-kertas { font-family: 'Courier Prime', monospace; background: #fff; color: #000; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-4 pb-20">
    <div class="max-w-md mx-auto">
        <div class="flex items-center gap-4 mb-6">
            <a href="dashboard.html" class="p-3 bg-white shadow-sm rounded-2xl text-gray-900 border border-gray-100">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            </a>
            <h1 class="text-2xl font-black text-gray-900 tracking-tighter">Penawaran & Email</h1>
        </div>

        <div class="flex border-b border-gray-200 mb-6 bg-white rounded-t-2xl">
            <button onclick="switchTab('buat')" id="tabBuat" class="flex-1 py-4 text-xs font-black tracking-widest tab-active uppercase">Buat Penawaran</button>
            <button onclick="switchTab('riwayat')" id="tabRiwayat" class="flex-1 py-4 text-xs font-black tracking-widest text-gray-400 uppercase">Riwayat</button>
            <button onclick="switchTab('email')" id="tabEmail" class="flex-1 py-4 text-xs font-black tracking-widest text-gray-400 uppercase">Kirim Email</button>
        </div>

        <div id="sectionBuat" class="space-y-5">
            <div class="bg-white p-6 rounded-[2.5rem] shadow-xl shadow-gray-200/50 border border-gray-100 space-y-4">
                <div class="flex bg-gray-100 p-1 rounded-xl mb-2">
                    <button onclick="setCust('lama')" id="btnLama" class="flex-1 py-2 text-[10px] font-black bg-white rounded-lg shadow-sm">MEMBER LAMA</button>
                    <button onclick="setCust('baru')" id="btnBaru" class="flex-1 py-2 text-[10px] font-black text-gray-400">MEMBER BARU</button>
                </div>
                
                <div>
                    <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-2 mb-1 block">Email / Nama Tujuan</label>
                    <input type="text" id="custInput" placeholder="Ketik nama atau email..." class="w-full bg-gray-50 p-4 rounded-2xl outline-none font-bold text-sm border-2 border-transparent focus:border-blue-500 transition-all">
                </div>

                <div id="itemContainer" class="space-y-3">
                    </div>

                <button onclick="addRow()" class="w-full py-3 border-2 border-dashed border-gray-200 rounded-2xl text-[10px] font-black text-gray-400 uppercase hover:bg-gray-50">+ Tambah Item Jasa</button>
            </div>

            <div class="bg-gray-900 p-6 rounded-[2.5rem] text-white flex justify-between items-end shadow-2xl">
                <div>
                    <span class="text-[10px] font-bold text-gray-400 block mb-1">TOTAL ESTIMASI</span>
                    <span id="totalP" class="text-2xl font-black text-blue-400">Rp 0</span>
                </div>
                <button onclick="simpanPenawaran()" class="bg-blue-600 px-6 py-4 rounded-2xl font-black text-xs uppercase tracking-widest active:scale-95 transition-all">Simpan & Draft</button>
            </div>
        </div>

        <div id="sectionRiwayat" class="hidden space-y-4">
            <div class="flex gap-2">
                <input type="text" id="searchR" oninput="filterR()" placeholder="Cari ID/Email..." class="flex-[2] p-4 bg-white rounded-2xl border border-gray-100 text-xs font-bold outline-none shadow-sm">
                <input type="date" id="dateR" onchange="filterR()" class="flex-1 p-4 bg-white rounded-2xl border border-gray-100 text-xs font-bold outline-none shadow-sm">
            </div>
            <div id="listR" class="space-y-3"></div>
        </div>

        <div id="sectionEmail" class="hidden">
            <form id="emailForm" class="space-y-5">
                <div class="bg-white p-6 rounded-[2.5rem] shadow-xl shadow-gray-200/50 border border-gray-100 space-y-4">
                    <div>
                        <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-2 block mb-2">Penerima</label>
                        <input type="email" id="penerima" required placeholder="customer@mail.com" class="w-full bg-gray-50 p-4 rounded-2xl outline-none focus:ring-2 ring-blue-500 font-bold text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-2 block mb-2">Subjek</label>
                        <input type="text" id="subjek" required placeholder="Penawaran Harga - Nanda Teknik" class="w-full bg-gray-50 p-4 rounded-2xl outline-none focus:ring-2 ring-blue-500 font-bold text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-2 block mb-2">Pesan</label>
                        <textarea id="pesan" rows="4" required class="w-full bg-gray-50 p-4 rounded-2xl outline-none focus:ring-2 ring-blue-500 font-medium text-sm"></textarea>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-2 block mb-2">Lampiran</label>
                        <input type="file" id="lampiran" class="hidden" onchange="showName()">
                        <label for="lampiran" class="w-full border-2 border-dashed border-gray-200 p-4 rounded-2xl flex flex-col items-center justify-center gap-2 cursor-pointer">
                            <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-width="2"/></svg>
                            <span id="fileName" class="text-[11px] font-bold text-gray-400 uppercase">Pilih File...</span>
                        </label>
                    </div>
                </div>
                <button type="submit" id="btnSubmit" class="w-full bg-gray-900 text-white py-5 rounded-[2rem] font-black text-xs uppercase tracking-widest shadow-2xl active:scale-95 transition-all">Kirim Email Sekarang</button>
            </form>
        </div>
    </div>

    <div id="pdfTemplate" class="hidden">
        <div id="printArea" class="p-8 nota-kertas" style="width: 210mm;">
            <div class="text-center border-b-2 border-black pb-4 mb-4">
                <h2 class="text-xl font-black uppercase">PENAWARAN HARGA</h2>
                <p style="font-size: 10px;">NANDA TEKNIK BANYUWANGI - 0823-3120-1148</p>
            </div>
            <div style="display: flex; justify-between; font-size: 12px; margin-bottom: 20px;">
                <div><p>ID: <span id="pID"></span></p><p>KE: <span id="pEmail"></span></p></div>
                <div style="text-align: right;"><p id="pTgl"></p></div>
            </div>
            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                <thead><tr style="border-bottom: 1px solid #000; text-align: left;"><th style="padding: 10px 0;">ITEM PEKERJAAN</th><th>QTY</th><th style="text-align: right;">TOTAL</th></tr></thead>
                <tbody id="pBody"></tbody>
            </table>
            <div style="margin-top: 20px; border-top: 2px solid #000; padding-top: 10px; text-align: right;">
                <h3 class="font-black">GRAND TOTAL: <span id="pTotal"></span></h3>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwLkx1H8hTDGlXbokOziXL8kZQg1gXuyTIoW18wSLu3Vj5PF1J-x1AL-GnyRYuRcVziDw/exec";
        let rData = [];

        function switchTab(t) {
            document.getElementById('sectionBuat').classList.toggle('hidden', t !== 'buat');
            document.getElementById('sectionRiwayat').classList.toggle('hidden', t !== 'riwayat');
            document.getElementById('sectionEmail').classList.toggle('hidden', t !== 'email');
            
            ['tabBuat', 'tabRiwayat', 'tabEmail'].forEach(id => {
                document.getElementById(id).classList.toggle('tab-active', id === 'tab' + t.charAt(0).toUpperCase() + t.slice(1));
                document.getElementById(id).classList.toggle('text-gray-400', id !== 'tab' + t.charAt(0).toUpperCase() + t.slice(1));
            });

            if(t === 'riwayat') loadRiwayat();
        }

        function setCust(mode) {
            document.getElementById('btnLama').className = mode === 'lama' ? "flex-1 py-2 text-[10px] font-black bg-white rounded-lg shadow-sm" : "flex-1 py-2 text-[10px] font-black text-gray-400";
            document.getElementById('btnBaru').className = mode === 'baru' ? "flex-1 py-2 text-[10px] font-black bg-white rounded-lg shadow-sm" : "flex-1 py-2 text-[10px] font-black text-gray-400";
        }

        function addRow() {
            const div = document.createElement('div');
            div.className = "item-row bg-gray-50 p-4 rounded-2xl flex gap-3 relative border border-gray-100";
            div.innerHTML = `
                <div class="flex-1">
                    <input type="text" placeholder="Item" class="w-full bg-transparent font-bold text-xs outline-none border-b border-gray-200 mb-2 i-nama">
                    <div class="flex gap-2">
                        <input type="number" value="1" oninput="calc()" class="w-12 bg-white rounded-lg p-1 text-center font-bold text-xs i-qty">
                        <input type="number" placeholder="Harga" oninput="calc()" class="flex-1 bg-white rounded-lg p-1 px-3 font-bold text-xs i-harga">
                    </div>
                </div>
                <button onclick="this.parentElement.remove(); calc();" class="text-red-300 font-bold">Ã—</button>`;
            document.getElementById('itemContainer').appendChild(div);
        }

        function calc() {
            let total = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                total += (row.querySelector('.i-qty').value * row.querySelector('.i-harga').value);
            });
            document.getElementById('totalP').innerText = "Rp " + total.toLocaleString('id-ID');
            return total;
        }

        async function simpanPenawaran() {
            const email = document.getElementById('custInput').value;
            const items = [];
            document.querySelectorAll('.item-row').forEach(r => {
                if(r.querySelector('.i-nama').value) {
                    items.push({nama: r.querySelector('.i-nama').value, qty: r.querySelector('.i-qty').value, harga: r.querySelector('.i-harga').value});
                }
            });

            if(!email || items.length === 0) return alert("Lengkapi data!");

            Swal.fire({title: 'Menyimpan...', didOpen: () => Swal.showLoading()});

            const payload = {
                action: "simpanPenawaran",
                id_nota: "OFF-" + Date.now().toString().slice(-6),
                email: email,
                items: items,
                total: calc(),
                status: "OFFER",
                tanggal: new Date().toLocaleDateString('id-ID', {day:'2-digit', month:'short', year:'numeric'})
            };

            try {
                await fetch(SCRIPT_URL, {method: 'POST', mode: 'no-cors', body: JSON.stringify(payload)});
                Swal.fire('Tersimpan!', 'Data penawaran masuk ke sheet. Silakan kirim email manual jika perlu.', 'success');
                // Auto fill email tab
                document.getElementById('penerima').value = email;
                document.getElementById('subjek').value = "PENAWARAN HARGA - NANDA TEKNIK (" + payload.id_nota + ")";
                document.getElementById('pesan').value = "Halo, berikut kami lampirkan penawaran harga untuk pengerjaan Anda. Terima kasih.";
            } catch(e) { alert("Gagal Simpan"); }
        }

        async function loadRiwayat() {
            const list = document.getElementById('listR');
            list.innerHTML = "<p class='text-center text-xs font-bold py-10 animate-pulse'>MEMUAT...</p>";
            try {
                const res = await fetch(SCRIPT_URL + "?type=penawaran");
                rData = await res.json();
                filterR();
            } catch(e) { list.innerHTML = "Gagal memuat."; }
        }

        function filterR() {
            const search = document.getElementById('searchR').value.toLowerCase();
            const date = document.getElementById('dateR').value;
            const list = document.getElementById('listR');
            list.innerHTML = "";

            rData.filter(n => {
                const matchS = (n.id_nota + n.email).toLowerCase().includes(search);
                const matchD = date ? new Date(n.tanggal).toDateString() === new Date(date).toDateString() : true;
                return matchS && matchD;
            }).forEach(n => {
                list.innerHTML += `
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center">
                        <div>
                            <p class="text-[8px] font-black text-gray-400">${n.id_nota} | ${n.tanggal}</p>
                            <p class="text-[11px] font-black uppercase text-gray-800">${n.email}</p>
                        </div>
                        <p class="text-[11px] font-black text-blue-600">Rp ${parseInt(n.total).toLocaleString('id-ID')}</p>
                    </div>`;
            });
        }

        // FUNGSI EMAIL ASLI ANDA
        function showName() {
            const input = document.getElementById('lampiran');
            document.getElementById('fileName').innerText = input.files[0].name;
            document.getElementById('fileName').classList.replace('text-gray-400', 'text-blue-600');
        }

        document.getElementById('emailForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSubmit');
            const fileInput = document.getElementById('lampiran');
            btn.disabled = true;
            btn.innerHTML = "MENGIRIM...";

            let fileData = null;
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                fileData = await new Promise((resolve) => {
                    reader.onload = (e) => resolve({
                        base64: e.target.result.split(',')[1],
                        name: file.name,
                        type: file.type
                    });
                    reader.readAsDataURL(file);
                });
            }

            const payload = {
                action: "kirimEmail",
                penerima: document.getElementById('penerima').value,
                subjek: document.getElementById('subjek').value,
                pesan: document.getElementById('pesan').value,
                file: fileData
            };

            try {
                const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await response.json();
                if(result.result === "success") {
                    Swal.fire('Berhasil!', 'Email telah terkirim ke pelanggan.', 'success');
                    document.getElementById('emailForm').reset();
                    document.getElementById('fileName').innerText = "Pilih File...";
                }
            } catch (err) { Swal.fire('Error', err.toString(), 'error'); }
            finally { btn.disabled = false; btn.innerHTML = "Kirim Email Sekarang"; }
        };

        window.onload = () => addRow();
    </script>
</body>
</html>
